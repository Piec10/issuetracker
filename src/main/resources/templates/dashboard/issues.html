<!DOCTYPE HTML>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">

    <link rel="stylesheet" th:href="@{/css/background.css}"/>
    <link rel="stylesheet" th:href="@{/css/home-fade.css}"/>
    <link rel="stylesheet" th:href="@{/css/issues-table.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <title>Issue Tracker | Project Issues</title>

</head>
<body>
<div th:replace="dashboard/dashboard-navbar :: navbar(dashboard)"></div>


<div class="base-color">

    <div class="container-fluid py-5 min-vh-100">
        <div class="row py-2 py-md-0"></div>
        <div class="row justify-content-center py-5">
            <div class="col-11 py-5 border rounded-3 bg-light">

                <div class="container-fluid">
                    <div class="row gy-2">
                        <div class="col-12 col-lg-auto order-2 order-md-1 text-center text-md-start">
                            <a class="btn btn-outline-secondary" th:href="@{/dashboard/projects}"><i
                                    class="bi bi-arrow-left"></i></a>
                            <a th:if="${projectRoles.isCollaborator}" class="btn btn-outline-secondary"
                               th:href="@{/dashboard/newIssue(projectId=${project.id})}">New Issue</a>
                        </div>
                        <div class="col-12 col-lg-auto flex-grow-1 order-1 order-md-2 text-center">
                            <span class="fw-bold fs-4" th:text="${project.title}"/>
                        </div>
                        <div class="col-12 col-lg-auto order-3 text-center text-md-end">

                            <div class="btn-group">

                                <a th:href="@{/dashboard/issues(projectId=${project.id},show=open)}"
                                   class="btn btn-outline-secondary"
                                   th:classappend="${show} == 'open' ? 'active' : ''"
                                   th:attr="aria-current=${show} == 'open' ? 'page'">

                                    Open (<span th:text="${openIssuesCount}"></span>)
                                </a>

                                <a th:href="@{/dashboard/issues(projectId=${project.id},show=closed)}"
                                   class="btn btn-outline-secondary"
                                   th:classappend="${show} == 'closed' ? 'active' : ''"
                                   th:attr="aria-current=${show} == 'closed' ? 'page'">

                                    Closed (<span th:text="${closedIssuesCount}"></span>)
                                </a>

                                <a th:href="@{/dashboard/issues(projectId=${project.id},show=all)}"
                                   class="btn btn-outline-secondary"
                                   th:classappend="${show} == 'all' ? 'active' : ''"
                                   th:attr="aria-current=${show} == 'all' ? 'page'">

                                    All (<span th:text="${openIssuesCount + closedIssuesCount}"></span>)
                                </a>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="text-secondary py-2">Issues</div>
                </div>


                <div th:switch="${#lists.isEmpty(issues)}">
                    <div th:case="true">

                        <div th:switch="${show}">
                            <div th:case="open">
                                <span>There are no open issues yet.</span>
                            </div>
                            <div th:case="closed">
                                <span>There are no closed issues yet.</span>
                            </div>
                            <div th:case="all">
                                <span>There are no issues yet.</span>
                            </div>
                        </div>

                    </div>
                    <div th:case="false">

                        <div class="container-fluid">
                            <div class="col">

                                <div class="d-md-none">
                                    <div class="row mb-3">
                                        <div class="col fw-bold">
                                            Sort by priority:
                                            <div class="btn-group ms-3">
                                                <a th:href="@{/dashboard/issues(projectId=${project.id},show=${show})}"
                                                   th:classappend="${(sort != 'priorityAsc' and sort != 'priorityDesc') ? 'active' : ''}"
                                                   class="btn btn-outline-secondary">
                                                    -
                                                </a>
                                                <a th:href="@{/dashboard/issues(projectId=${project.id},show=${show},sort=priorityAsc)}"
                                                   th:classappend="${sort} == 'priorityAsc' ? 'active' : ''"
                                                   class="btn btn-outline-secondary">
                                                    ↓
                                                </a>
                                                <a th:href="@{/dashboard/issues(projectId=${project.id},show=${show},sort=priorityDesc)}"
                                                   th:classappend="${sort} == 'priorityDesc' ? 'active' : ''"
                                                   class="btn btn-outline-secondary">
                                                    ↑
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-none d-md-block">
                                    <div class="row p-2 mx-0 fw-bold">
                                        <div th:class="${(show == 'open') ? 'col-6 col-lg-5 col-xl-4 col-xxl-3' : 'col-4 col-lg-3 col-xxl-2'}">
                                            <div class="row">
                                                <div class="col">
                                                    <div th:switch="${sort == 'noop' or sort == 'priorityDesc'}">
                                                        <div th:case="true">
                                                            <a th:href="@{/dashboard/issues(projectId=${project.id},show=${show},sort=priorityAsc)}">
                                                                <span th:text="${sort == 'priorityDesc' ? 'Priority ↑' : 'Priority'}"/>
                                                            </a>
                                                        </div>
                                                        <div th:case="false">
                                                            <a th:href="@{/dashboard/issues(projectId=${project.id},show=${show},sort=priorityDesc)}">
                                                                Priority ↓
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col">Type</div>
                                                <div class="col" th:if="${show == 'open'}">Status</div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="row">
                                                <div class="col">Summary</div>
                                                <div class="col-4 col-xl-3">Reporter</div>
                                                <div th:if="${show == 'closed' or show == 'all'}"
                                                     class="col-4 col-xl-3">Closed
                                                    by
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div th:each="tempIssue : ${issues}">

                                <!-- hidden form for performing delete issue request -->
                                <form th:name="'deleteIssueForm_'+${tempIssue.id}"
                                      th:action="@{'/dashboard/deleteIssue/'+${tempIssue.id}}"
                                      th:method="delete" th:hidden="true">
                                    <input hidden type="submit" value="Delete"/>
                                </form>

                                <!-- hidden form for performing close issue request -->
                                <form th:name="'closeIssueForm_'+${tempIssue.id}"
                                      th:action="@{'/dashboard/closeIssue/'+${tempIssue.id}}"
                                      th:method="patch" th:hidden="true">
                                    <input hidden type="submit" value="Patch"/>
                                </form>

                                <!-- hidden form for performing reopen issue request -->
                                <form th:name="'reopenIssueForm_'+${tempIssue.id}"
                                      th:action="@{'/dashboard/reopenIssue/'+${tempIssue.id}}"
                                      th:method="patch" th:hidden="true">
                                    <input hidden type="submit" value="Patch"/>
                                </form>

                                <!-- hidden forms for performing change issue status request -->

                                <!-- add form for each status -->
                                <div th:each="issueStatus : ${allIssueStatuses}">
                                    <form th:name="'changeIssueStatusForm_'+${tempIssue.id}+${issueStatus.id}"
                                          th:action="@{'/dashboard/changeIssueStatus/'+${tempIssue.id}(statusId=${issueStatus.id})}"
                                          th:method="patch" th:hidden="true">
                                        <input hidden type="submit" value="Patch"/>
                                    </form>
                                </div>


                                <!-- Issue Details Modal -->
                                <div class="modal fade" th:id="'issueDetailsModal_'+${tempIssue.id}" tabindex="-1"
                                     th:aria-labelledby="'issueDetailsModalLabel_'+${tempIssue.id}" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content bg-light">
                                            <div class="modal-header px-4">
                                                <h1 class="modal-title fs-4"
                                                    th:id="'issueDetailsModalLabel_'+${tempIssue.id}">
                                                    #<span th:text="${tempIssue.id}"/> <span
                                                        th:text="${tempIssue.summary}"/></h1>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <div class="row row-cols-2 row-cols-md-3 text-md-center gy-2">
                                                            <div class="col">
                                                                Priority:
                                                                <span th:text="${priorities.getName(tempIssue.priority)}"/>
                                                            </div>
                                                            <div class="col">
                                                                Type:
                                                                <span th:text="${(tempIssue.issueType == null) ? '' : tempIssue.issueType.name}"/>
                                                            </div>
                                                            <div class="col">
                                                                Status:
                                                                <span th:text="${(tempIssue.issueStatus == null) ? '' : tempIssue.issueStatus.name}"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div th:switch="${tempIssue.description == null}">
                                                            <div th:case="true">
                                                                <span>No description</span>
                                                            </div>
                                                            <div th:case="false">
                                                        <span style="white-space: pre-line"
                                                              th:text="${tempIssue.description}"/>
                                                            </div>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>

                                            <div class="modal-footer"
                                                 th:if="${#authorization.expression('hasAuthority(''ROLE_ADMIN'')') or (projectRoles.isOwner) or (tempIssue.createdBy != null ? (tempIssue.createdBy.username == #authentication.getPrincipal().getUsername()) : false)}">
                                                <div class="row w-100">
                                                    <div class="col" th:unless="${tempIssue.closedAt}">
                                                        <a th:href="@{/dashboard/editIssue(issueId=${tempIssue.id})}"
                                                           class="btn w-100 btn-outline-secondary">
                                                            Edit Issue
                                                        </a>
                                                    </div>
                                                    <div class="col">
                                                        <div th:switch="${tempIssue.closedAt == null}">
                                                            <div th:case="true">
                                                                <a th:href="'javascript: document.closeIssueForm_'+${tempIssue.id}+'.submit()'"
                                                                   class="btn w-100 btn-outline-secondary"
                                                                   onclick="if (!(confirm('Are you sure you want to close this issue?'))) return false">
                                                                    Close Issue
                                                                </a>
                                                            </div>
                                                            <div th:case="false">
                                                                <a th:href="'javascript: document.reopenIssueForm_'+${tempIssue.id}+'.submit()'"
                                                                   class="btn w-100 btn-outline-secondary"
                                                                   onclick="if (!(confirm('Are you sure you want to reopen this issue?'))) return false">
                                                                    Reopen Issue
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <a th:href="'javascript: document.deleteIssueForm_'+${tempIssue.id}+'.submit()'"
                                                           class="btn w-100 btn-outline-secondary"
                                                           onclick="if (!(confirm('Are you sure you want to delete this issue?'))) return false">
                                                            Delete Issue
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <div class="d-md-none">

                                    <div class="accordion" th:id="'accordion'+${tempIssue.id}">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" th:id="'heading'+${tempIssue.id}">
                                                <div class="btn-group w-100 border-bottom rounded-0" role="group"
                                                     aria-label="Basic example">
                                                    <a href="" data-bs-toggle="modal"
                                                       th:data-bs-target="'#issueDetailsModal_'+${tempIssue.id}"
                                                       class="btn btn-light text-start " style="">
                                                        <span th:text="${tempIssue.summary}"/>
                                                    </a>

                                                    <button class="accordion-button bg-light collapsed"
                                                            style="width: 60px;"
                                                            type="button" data-bs-toggle="collapse"
                                                            th:data-bs-target="'#collapse'+${tempIssue.id}"
                                                            aria-expanded="false"
                                                            th:aria-controls="'collapse'+${tempIssue.id}">

                                                    </button>
                                                </div>
                                            </h2>
                                            <div th:id="'collapse'+${tempIssue.id}" class="accordion-collapse collapse"
                                                 th:aria-labelledby="'heading'+${tempIssue.id}">
                                                <div class="accordion-body">

                                                    <div class="row gy-3">
                                                        <div class="col-6">
                                                            #<span th:text="${tempIssue.id}"/>
                                                        </div>
                                                        <div class="col-6 text-end">
                                                            <div th:if="${#authorization.expression('hasAuthority(''ROLE_ADMIN'')') or (projectRoles.isOwner) or (tempIssue.createdBy != null ? (tempIssue.createdBy.username == #authentication.getPrincipal().getUsername()) : false)}">

                                                                <div class="dropdown">
                                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                                            type="button" data-bs-toggle="dropdown"
                                                                            aria-expanded="false">
                                                                        Action
                                                                    </button>
                                                                    <ul class="dropdown-menu">


                                                                        <div th:switch="${tempIssue.closedAt == null}">
                                                                            <div th:case="true">
                                                                                <li><a class="dropdown-item"
                                                                                       th:href="@{/dashboard/editIssue(issueId=${tempIssue.id})}">Edit</a>
                                                                                </li>
                                                                                <li><a class="dropdown-item"
                                                                                       th:href="'javascript: document.closeIssueForm_'+${tempIssue.id}+'.submit()'"
                                                                                       onclick="if (!(confirm('Are you sure you want to close this issue?'))) return false">Close</a>
                                                                                </li>
                                                                            </div>
                                                                            <div th:case="false">
                                                                                <li><a class="dropdown-item"
                                                                                       th:href="'javascript: document.reopenIssueForm_'+${tempIssue.id}+'.submit()'"
                                                                                       onclick="if (!(confirm('Are you sure you want to reopen this issue?'))) return false">Reopen</a>
                                                                                </li>
                                                                            </div>
                                                                        </div>

                                                                        <li><a class="dropdown-item"
                                                                               th:href="'javascript: document.deleteIssueForm_'+${tempIssue.id}+'.submit()'"
                                                                               onclick="if (!(confirm('Are you sure you want to delete this issue?'))) return false">Delete</a>
                                                                        </li>
                                                                    </ul>
                                                                </div>

                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div th:switch="${tempIssue.description == null}">
                                                                <div th:case="true">
                                                                    <span>No description</span>
                                                                </div>
                                                                <div th:case="false">
                                                                    <span style="white-space: pre-line"
                                                                          th:text="${tempIssue.description}"/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            Type:
                                                            <span th:text="${(tempIssue.issueType == null) ? '' : tempIssue.issueType.name}"/>
                                                        </div>
                                                        <div class="col-6">
                                                            Priority:
                                                            <span th:text="${priorities.getName(tempIssue.priority)}"/>
                                                        </div>
                                                        <div class="col-12" th:if="${show == 'open'}">
                                                            Status:
                                                            <span th:text="${(tempIssue.issueStatus == null) ? '' : tempIssue.issueStatus.name}"/>
                                                        </div>
                                                        <div class="col-12">
                                                            <div th:switch="${tempIssue.createdBy == null}">
                                                                <div th:case="true">
                                                                    Reporter:
                                                                    <small class="text-secondary fst-italic">
                                                                        deleted user
                                                                    </small>
                                                                </div>
                                                                <div th:case="false">
                                                                    Reporter:
                                                                    <span th:text="${tempIssue.createdBy.username}"/>
                                                                </div>
                                                            </div>
                                                            <small><span th:text="${tempIssue.createdAt}"/></small>
                                                        </div>
                                                        <div class="col-12">
                                                            <div th:if="${tempIssue.closedAt != null}">
                                                                <div th:switch="${tempIssue.closedBy == null}">
                                                                    <div th:case="true">
                                                                        Closed by:
                                                                        <small class="text-secondary fst-italic">
                                                                            deleted user
                                                                        </small>
                                                                    </div>
                                                                    <div th:case="false">
                                                                        Closed by:
                                                                        <span th:text="${tempIssue.closedBy.username}"/>
                                                                    </div>
                                                                </div>
                                                                <small><span th:text="${tempIssue.closedAt}"/></small>
                                                            </div>

                                                        </div>
                                                    </div>


                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-none d-md-block">
                                    <hr class="hr-table">

                                    <div class="row clickable-row p-2 mx-0">
                                        <div th:class="${(show == 'open') ? 'col-6 col-lg-5 col-xl-4 col-xxl-3' : 'col-4 col-lg-3 col-xxl-2'}">
                                            <div class="row">
                                                <div class="col">
                                                    <button class="btn w-100 btn-sm btn-outline-secondary"
                                                            style="font-size: 0.8rem">
                                                        <span th:text="${priorities.getName(tempIssue.priority)}"/>
                                                    </button>
                                                </div>
                                                <div class="col">
                                                    <button class="btn w-100 btn-sm btn-outline-secondary"
                                                            style="font-size: 0.8rem">
                                                        <span th:text="${(tempIssue.issueType == null) ? 'Set type:' : tempIssue.issueType.name}"/>
                                                    </button>
                                                </div>
                                                <div class="col" th:if="${show == 'open'}">
<!--                                                    <div th:switch="${#authorization.expression('hasAuthority(''ROLE_ADMIN'')') or (projectRoles.isOwner) or (tempIssue.createdBy != null ? (tempIssue.createdBy.username == #authentication.getPrincipal().getUsername()) : false)}">-->
<!--                                                        <div th:case="true">-->
                                                            <div class="dropdown">
                                                                <button class="btn w-100 btn-sm btn-outline-secondary"
                                                                        style="font-size: 0.8rem;"
                                                                        type="button" data-bs-toggle="dropdown"
                                                                        aria-expanded="false">
                                                                    <span th:text="${(tempIssue.issueStatus == null) ? 'Set status:' : tempIssue.issueStatus.name}"/>
                                                                </button>
                                                                <ul class="dropdown-menu" th:if="${#authorization.expression('hasAuthority(''ROLE_ADMIN'')') or (projectRoles.isOwner) or (tempIssue.createdBy != null ? (tempIssue.createdBy.username == #authentication.getPrincipal().getUsername()) : false)}">
                                                                    <li th:each="issueStatus : ${allIssueStatuses}">
                                                                        <a class="dropdown-item"
                                                                           th:href="'javascript: document.changeIssueStatusForm_'+${tempIssue.id}+${issueStatus.id}+'.submit()'">
                                                                            <span th:text="${issueStatus.name}"/>
                                                                        </a>
                                                                    </li>
                                                                </ul>
                                                            </div>
<!--                                                        </div>-->
<!--                                                        <div th:case="false">-->
<!--                                                            <span th:text="${(tempIssue.issueStatus == null) ? '' : tempIssue.issueStatus.name}"/>-->
<!--                                                        </div>-->
<!--                                                    </div>-->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="row position-relative">

                                                <div class="col"><span th:text="${tempIssue.summary}"/></div>


                                                <div class="col-4 col-xl-3">
                                                    <div th:switch="${tempIssue.createdBy == null}">
                                                        <div th:case="true">
                                                            <small class="text-secondary fst-italic">
                                                                deleted user
                                                            </small>
                                                        </div>
                                                        <div th:case="false">
                                                            <span th:text="${tempIssue.createdBy.username}"/>
                                                        </div>
                                                    </div>
                                                    <small><span th:text="${tempIssue.createdAt}"/></small>
                                                </div>
                                                <div class="col-4 col-xl-3"
                                                     th:if="${show == 'closed' or show == 'all'}">
                                                    <div th:if="${tempIssue.closedAt != null}">
                                                        <div th:switch="${tempIssue.closedBy == null}">
                                                            <div th:case="true">
                                                                <small class="text-secondary fst-italic">
                                                                    deleted user
                                                                </small>
                                                            </div>
                                                            <div th:case="false">
                                                                <span th:text="${tempIssue.closedBy.username}"/>
                                                            </div>
                                                        </div>
                                                        <small><span th:text="${tempIssue.closedAt}"/></small>
                                                    </div>
                                                </div>

                                                <a href="" data-bs-toggle="modal"
                                                   th:data-bs-target="'#issueDetailsModal_'+${tempIssue.id}"
                                                   class="stretched-link"></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

</div>

<!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
</body>
</html>